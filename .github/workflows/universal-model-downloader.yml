name: Universal Model Downloader
on:
  workflow_dispatch:
    inputs:
      model_url:
        description: 'URL ×©×œ ×”××•×“×œ ×œ×”×•×¨×“×” (Dropbox/Google Drive/HuggingFace/Azure)'
        required: true
        type: string
      model_name:
        description: '×©× ×”××•×“×œ (×™×©××© ×›×ª×™×§×™×™×”)'
        required: true
        type: string
      split_size_mb:
        description: '×’×•×“×œ ×¤×™×¦×•×œ ×‘-MB (×‘×¨×™×¨×ª ××—×“×œ: 95)'
        required: false
        default: '95'
        type: string
      file_extension:
        description: '×¡×™×•××ª ×”×§×•×‘×¥ (pth/bin/safetensors/onnx)'
        required: false
        default: 'pth'
        type: string

jobs:
  download-and-split:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests PyYAML
      
      - name: Download model
        run: |
          echo "ğŸš€ ××ª×—×™×œ ×”×•×¨×“×” ×-${{ github.event.inputs.model_url }}"
          
          # ×–×™×”×•×™ ××•×˜×•××˜×™ ×©×œ ×¡×•×’ ×”-URL
          MODEL_URL="${{ github.event.inputs.model_url }}"
          
          if [[ $MODEL_URL == *"dropbox.com"* ]]; then
            echo "ğŸ“¦ ×–×•×”×” Dropbox URL"
            # ×”××¨×” ×œ-direct download
            MODEL_URL="${MODEL_URL/www.dropbox.com/dl.dropboxusercontent.com}"
            MODEL_URL="${MODEL_URL/?dl=0/?dl=1}"
          elif [[ $MODEL_URL == *"drive.google.com"* ]]; then
            echo "ğŸ“¦ ×–×•×”×” Google Drive URL"
            # ×—×™×œ×•×¥ file ID
            FILE_ID=$(echo $MODEL_URL | grep -oP '(?<=d/)[^/]+|(?<=id=)[^&]+')
            MODEL_URL="https://drive.google.com/uc?export=download&id=$FILE_ID"
          elif [[ $MODEL_URL == *"huggingface.co"* ]]; then
            echo "ğŸ“¦ ×–×•×”×” HuggingFace URL"
            # ×›×‘×¨ URL ×™×©×™×¨
          fi
          
          echo "ğŸ“¥ ××•×¨×™×“ ×: $MODEL_URL"
          wget -O model_temp.${{ github.event.inputs.file_extension }} "$MODEL_URL" \
            --progress=bar:force:noscroll \
            --no-check-certificate \
            --timeout=300 \
            --tries=3
          
          echo "âœ… ×”×•×¨×“×” ×”×•×©×œ××”!"
          ls -lh model_temp.${{ github.event.inputs.file_extension }}
      
      - name: Split model into parts
        run: |
          SPLIT_SIZE_MB=${{ github.event.inputs.split_size_mb }}
          SPLIT_SIZE_BYTES=$((SPLIT_SIZE_MB * 1024 * 1024))
          MODEL_NAME="${{ github.event.inputs.model_name }}"
          FILE_EXT="${{ github.event.inputs.file_extension }}"
          
          echo "âœ‚ï¸  ××¤×¦×œ ×§×•×‘×¥ ×œ×—×œ×§×™× ×©×œ ${SPLIT_SIZE_MB}MB..."
          
          # ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×œ××•×“×œ
          mkdir -p "$MODEL_NAME"
          
          # ×¤×™×¦×•×œ ×”×§×•×‘×¥
          split -b $SPLIT_SIZE_BYTES \
            -d \
            --additional-suffix=.part \
            model_temp.$FILE_EXT \
            "$MODEL_NAME/model_final.$FILE_EXT."
          
          # ×™×¦×™×¨×ª ×§×•×‘×¥ config
          cat > "$MODEL_NAME/config.yml" << EOF
          model_name: $MODEL_NAME
          original_url: ${{ github.event.inputs.model_url }}
          file_extension: $FILE_EXT
          split_size_mb: $SPLIT_SIZE_MB
          total_size_bytes: $(stat -c%s model_temp.$FILE_EXT)
          parts_count: $(ls $MODEL_NAME/model_final.$FILE_EXT.*.part | wc -l)
          created_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          sha256: $(sha256sum model_temp.$FILE_EXT | cut -d' ' -f1)
          EOF
          
          # ×™×¦×™×¨×ª ×¡×§×¨×™×¤×˜ ××™×—×•×“
          cat > "$MODEL_NAME/merge.py" << 'MERGE_SCRIPT'
          #!/usr/bin/env python3
          """
          ×¡×§×¨×™×¤×˜ ××™×—×•×“ ×—×œ×§×™× ×œ××•×“×œ ×©×œ×
          """
          import os
          import glob
          import yaml
          from pathlib import Path
          
          def merge_model():
              # ×§×¨×™××ª config
              with open('config.yml') as f:
                  config = yaml.safe_load(f)
              
              model_name = config['model_name']
              file_ext = config['file_extension']
              output_file = f"model_final.{file_ext}"
              
              print(f"ğŸ”„ ×××—×“ {config['parts_count']} ×—×œ×§×™×...")
              
              # ××¦×™××ª ×›×œ ×”×—×œ×§×™×
              parts = sorted(glob.glob(f"model_final.{file_ext}.*.part"))
              
              if not parts:
                  print("âŒ ×œ× × ××¦××• ×—×œ×§×™×!")
                  return False
              
              print(f"   × ××¦××• {len(parts)} ×—×œ×§×™×")
              
              # ××™×—×•×“
              with open(output_file, 'wb') as outfile:
                  for i, part in enumerate(parts, 1):
                      print(f"   ×××—×“ ×—×œ×§ {i}/{len(parts)}: {part}")
                      with open(part, 'rb') as infile:
                          outfile.write(infile.read())
              
              # ×‘×“×™×§×ª ×’×•×“×œ
              final_size = os.path.getsize(output_file)
              expected_size = config['total_size_bytes']
              
              if final_size == expected_size:
                  print(f"âœ… ××™×—×•×“ ×”×•×©×œ× ×‘×”×¦×œ×—×”!")
                  print(f"   ×§×•×‘×¥: {output_file}")
                  print(f"   ×’×•×“×œ: {final_size / (1024*1024):.1f} MB")
                  return True
              else:
                  print(f"âš ï¸  ××–×”×¨×”: ×’×•×“×œ ×œ× ×ª×•××!")
                  print(f"   ×¦×¤×•×™: {expected_size / (1024*1024):.1f} MB")
                  print(f"   ×‘×¤×•×¢×œ: {final_size / (1024*1024):.1f} MB")
                  return False
          
          if __name__ == '__main__':
              merge_model()
          MERGE_SCRIPT
          
          chmod +x "$MODEL_NAME/merge.py"
          
          # ×™×¦×™×¨×ª README
          cat > "$MODEL_NAME/README.md" << EOF
          # $MODEL_NAME
          
          ××•×“×œ ×©×”×•×¨×“ ××•×˜×•××˜×™ ×“×¨×š GitHub Actions
          
          ## ××™×“×¢
          - **×’×•×“×œ ×›×•×œ×œ**: $(numfmt --to=iec-i --suffix=B $(stat -c%s model_temp.$FILE_EXT))
          - **××¡×¤×¨ ×—×œ×§×™×**: $(ls $MODEL_NAME/model_final.$FILE_EXT.*.part | wc -l)
          - **×’×•×“×œ ×›×œ ×—×œ×§**: ~${SPLIT_SIZE_MB}MB
          - **URL ××§×•×¨×™**: ${{ github.event.inputs.model_url }}
          - **×ª××¨×™×š ×”×•×¨×“×”**: $(date)
          
          ## ××™×š ×œ×”×©×ª××©
          
          1. ×”×•×¨×“ ××ª ×›×œ ×”×§×‘×¦×™× ×‘×ª×™×§×™×™×” ×–×•
          2. ×”×¨×¥ ××ª ×¡×§×¨×™×¤×˜ ×”××™×—×•×“:
             \`\`\`bash
             python merge.py
             \`\`\`
          3. ×”×§×•×‘×¥ \`model_final.$FILE_EXT\` ×™×ª×§×‘×œ
          
          ## ×”×•×¨×“×” ××”×™×¨×”
          
          \`\`\`bash
          # ×”×•×¨×“×” ×¢× git
          git clone --depth 1 --filter=blob:none --sparse \\
            https://github.com/${{ github.repository }}.git
          cd $(basename ${{ github.repository }})
          git sparse-checkout set $MODEL_NAME
          
          # ××™×—×•×“
          cd $MODEL_NAME
          python merge.py
          \`\`\`
          
          ## ××• ×¢× wget
          
          \`\`\`bash
          # ×”×•×¨×“×ª ×›×œ ×”×—×œ×§×™×
          BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/$MODEL_NAME"
          
          wget \$BASE_URL/config.yml
          wget \$BASE_URL/merge.py
          
          # ×”×•×¨×“×ª ×”×—×œ×§×™× (×”×ª×× ××ª ×”××¡×¤×¨)
          for i in {00..$(printf "%02d" $(($(ls $MODEL_NAME/model_final.$FILE_EXT.*.part | wc -l) - 1)))}; do
            wget "\$BASE_URL/model_final.$FILE_EXT.\${i}.part"
          done
          
          # ××™×—×•×“
          python merge.py
          \`\`\`
          EOF
          
          # ××—×™×§×ª ×”×§×•×‘×¥ ×”×–×× ×™
          rm model_temp.$FILE_EXT
          
          echo "âœ… ×¤×™×¦×•×œ ×”×•×©×œ×!"
          echo "ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×”:"
          ls -lh "$MODEL_NAME/"
      
      - name: Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add "${{ github.event.inputs.model_name }}/"
          git commit -m "Add model: ${{ github.event.inputs.model_name }}"
          git push
          
          echo "âœ… ×”××•×“×œ ×¢×œ×” ×‘×”×¦×œ×—×” ×œ-repo!"
          echo "ğŸ”— ×¦×¤×” ×‘-https://github.com/${{ github.repository }}/tree/main/${{ github.event.inputs.model_name }}"
